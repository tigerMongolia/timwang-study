#### ä¸€ã€æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

æŸ¥çœ‹äº†ä¸‹é˜¿é‡Œäº‘ Redis çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Šå¦‚ä¸‹ï¼Œèƒ½å¤Ÿè¾¾åˆ°æ•°åä¸‡ã€ç™¾ä¸‡çº§åˆ«çš„ QPSï¼ˆæš‚æ—¶å¿½ç•¥é˜¿é‡Œå¯¹ Redis æ‰€åšçš„ä¼˜åŒ–ï¼‰ï¼Œæˆ‘ä»¬ä» Redis çš„è®¾è®¡å’Œå®ç°æ¥åˆ†æä¸€ä¸‹ Redis æ˜¯æ€ä¹ˆåšçš„ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghgb3ns5fvj30rr0kdjsx.jpg)

#### äºŒã€Redis çš„è®¾è®¡ä¸å®ç°

å…¶å® Redis ä¸»è¦æ˜¯é€šè¿‡ä¸‰ä¸ªæ–¹é¢æ¥æ»¡è¶³è¿™æ ·é«˜æ•ˆååé‡çš„æ€§èƒ½éœ€æ±‚

- é«˜æ•ˆçš„æ•°æ®ç»“æ„
- å¤šè·¯å¤ç”¨ IO æ¨¡å‹
- äº‹ä»¶æœºåˆ¶

##### 2.1 é«˜æ•ˆçš„æ•°æ®ç»“æ„

Redis æ”¯æŒçš„å‡ ç§é«˜æ•ˆçš„æ•°æ®ç»“æ„ stringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€hashï¼ˆå“ˆå¸Œï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ã€setï¼ˆé›†åˆï¼‰ã€zsetï¼ˆæœ‰åºé›† åˆï¼‰

ä»¥ä¸Šå‡ ç§å¯¹å¤–æš´éœ²çš„æ•°æ®ç»“æ„å®ƒä»¬çš„åº•å±‚ç¼–ç æ–¹å¼éƒ½æ˜¯åšäº†ä¸åŒçš„ä¼˜åŒ–çš„ï¼Œä¾‹å¦‚stringä¸Šä¸€ç« èŠ‚å°±æœ‰è®²åˆ°

##### 2.2 å¤šè·¯å¤ç”¨IOæ¨¡å‹

å‡è®¾æŸä¸€æ—¶åˆ»ä¸ Redis æœåŠ¡å™¨å»ºç«‹äº† 1 ä¸‡ä¸ªé•¿è¿æ¥ï¼Œå¯¹äºé˜»å¡å¼ IO çš„åšæ³•å°±æ˜¯ï¼Œå¯¹æ¯ä¸€æ¡è¿æ¥éƒ½å»ºç«‹ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œé‚£ä¹ˆå°±éœ€è¦ 1ä¸‡ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶æ ¹æ®æˆ‘ä»¬çš„ç»éªŒå¯¹äº IO å¯†é›†å‹çš„æ“ä½œæˆ‘ä»¬ä¸€èˆ¬è®¾ç½®ï¼Œçº¿ç¨‹æ•° = 2 * CPU æ•°é‡ + 1ï¼Œå¯¹äº CPU å¯†é›†å‹çš„æ“ä½œä¸€èˆ¬è®¾ç½®çº¿ç¨‹ = CPU æ•°é‡ + 1ï¼Œå½“ç„¶å„ç§ä¹¦ç±æˆ–è€…ç½‘ä¸Šä¹Ÿæœ‰ä¸€ä¸ªè¯¦ç»†çš„è®¡ç®—å…¬å¼å¯ä»¥ç®—å‡ºæ›´åŠ åˆé€‚å‡†ç¡®çš„çº¿ç¨‹æ•°é‡ï¼Œä½†æ˜¯å¾—åˆ°çš„ç»“æœå¾€å¾€æ˜¯ä¸€ä¸ªæ¯”è¾ƒå°çš„å€¼ï¼Œåƒé˜»å¡å¼ IO è¿™ä¹ŸåŠ¨åˆ™åˆ›å»ºæˆåƒä¸Šä¸‡çš„çº¿ç¨‹ï¼Œç³»ç»Ÿæ˜¯æ— æ³•æ‰¿è½½è¿™æ ·çš„è´Ÿè·çš„æ›´åŠ å¼¹ä¸ä¸Šé«˜æ•ˆçš„ååé‡å’ŒæœåŠ¡äº†ã€‚

è€Œå¤šè·¯å¤ç”¨ IO æ¨¡å‹çš„åšæ³•æ˜¯ï¼Œç”¨ä¸€ä¸ªçº¿ç¨‹å°†è¿™ä¸€ä¸‡ä¸ªå»ºç«‹æˆåŠŸçš„é“¾æ¥é™†ç»­çš„æ”¾å…¥ event_pollï¼Œevent_poll ä¼šä¸ºè¿™ä¸€ä¸‡ä¸ªé•¿è¿æ¥æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå½“æŸä¸€ä¸ªé•¿è¿æ¥å‡†å¤‡å°±ç»ªåï¼ˆå»ºç«‹å»ºç«‹æˆåŠŸã€æ•°æ®è¯»å–å®Œæˆç­‰ï¼‰ï¼Œå°±ä¼šé€šè¿‡å›è°ƒå‡½æ•°å†™å…¥åˆ° event_poll çš„å°±ç»ªé˜Ÿåˆ— rdlist ä¸­ï¼Œè¿™æ ·è¿™ä¸ªå•çº¿ç¨‹å°±å¯ä»¥é€šè¿‡è¯»å– rdlist è·å–åˆ°éœ€è¦çš„æ•°æ®

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghhgnxsnc5j30my0c474x.jpg)

redisåˆ©ç”¨epollæ¥å®ç°IOå¤šè·¯å¤ç”¨ï¼Œå°†è¿æ¥ä¿¡æ¯å’Œäº‹ä»¶æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¾æ¬¡æ”¾åˆ°æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼Œäº‹ä»¶åˆ†æ´¾å™¨å°†äº‹ä»¶åˆ†å‘ç»™äº‹ä»¶å¤„ç†å™¨ã€‚

äº‹ä»¶å¤„ç†å™¨å¯¹ä¸åŒçš„äº‹ä»¶ï¼Œè¿›è¡Œå¤„ç†ã€‚

##### 2.3 å¤šè·¯å¤ç”¨IO ä¸¾ä¸ªğŸŒ°

###### 2.3.1 ç»è¥æ–¹å¼ä¸€

å®¢æˆ·æ¯é€æ¥ä¸€ä»½å¿«é€’ï¼Œå°æ›²å°±è®©ä¸€ä¸ªå¿«é€’å‘˜ç›¯ç€ï¼Œç„¶åå¿«é€’å‘˜å¼€è½¦å»é€å¿«é€’ã€‚æ…¢æ…¢çš„å°æ›²å°±å‘ç°äº†è¿™ç§ç»è¥æ–¹å¼å­˜åœ¨ä¸‹è¿°é—®é¢˜

- å‡ åä¸ªå¿«é€’å‘˜åŸºæœ¬ä¸Šæ—¶é—´éƒ½èŠ±åœ¨äº†æŠ¢è½¦ä¸Šäº†ï¼Œå¤§éƒ¨åˆ†å¿«é€’å‘˜éƒ½å¤„åœ¨é—²ç½®çŠ¶æ€ï¼Œè°æŠ¢åˆ°äº†è½¦ï¼Œè°å°±èƒ½å»é€å¿«é€’
- éšç€å¿«é€’çš„å¢å¤šï¼Œå¿«é€’å‘˜ä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œå°æ›²å‘ç°å¿«é€’åº—é‡Œè¶Šæ¥è¶ŠæŒ¤ï¼Œæ²¡åŠæ³•é›‡ä½£æ–°çš„å¿«é€’å‘˜äº†
- å¿«é€’å‘˜ä¹‹é—´çš„åè°ƒå¾ˆèŠ±æ—¶é—´

ç»¼åˆä¸Šè¿°ç¼ºç‚¹ï¼Œå°æ›²ç—›å®šæ€ç—›ï¼Œæå‡ºäº†ä¸‹é¢çš„ç»è¥æ–¹å¼

###### 2.3.2 **ç»è¥æ–¹å¼äºŒ**

å°æ›²åªé›‡ä½£ä¸€ä¸ªå¿«é€’å‘˜ã€‚ç„¶åå‘¢ï¼Œå®¢æˆ·é€æ¥çš„å¿«é€’ï¼Œå°æ›²æŒ‰**é€è¾¾åœ°ç‚¹**æ ‡æ³¨å¥½ï¼Œç„¶å**ä¾æ¬¡**æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚æœ€åï¼Œé‚£ä¸ªå¿«é€’å‘˜**ä¾æ¬¡**çš„å»å–å¿«é€’ï¼Œä¸€æ¬¡æ‹¿ä¸€ä¸ªï¼Œç„¶åå¼€ç€è½¦å»é€å¿«é€’ï¼Œé€å¥½äº†å°±å›æ¥æ‹¿ä¸‹ä¸€ä¸ªå¿«é€’ã€‚åœ¨ä¸Šè¿°æ¯”å–»ä¸­:

- æ¯ä¸ªå¿«é€’å‘˜------------------>æ¯ä¸ªçº¿ç¨‹
- æ¯ä¸ªå¿«é€’-------------------->æ¯ä¸ªsocket(I/Oæµ)
- å¿«é€’çš„é€è¾¾åœ°ç‚¹-------------->socketçš„ä¸åŒçŠ¶æ€
- å®¢æˆ·é€å¿«é€’è¯·æ±‚-------------->æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚
- å°æ›²çš„ç»è¥æ–¹å¼-------------->æœåŠ¡ç«¯è¿è¡Œçš„ä»£ç 
- ä¸€è¾†è½¦---------------------->CPUçš„æ ¸æ•°

äºæ˜¯æˆ‘ä»¬æœ‰å¦‚ä¸‹ç»“è®º
1ã€ç»è¥æ–¹å¼ä¸€å°±æ˜¯ä¼ ç»Ÿçš„å¹¶å‘æ¨¡å‹ï¼Œæ¯ä¸ªI/Oæµ(å¿«é€’)éƒ½æœ‰ä¸€ä¸ªæ–°çš„çº¿ç¨‹(å¿«é€’å‘˜)ç®¡ç†ã€‚
2ã€ç»è¥æ–¹å¼äºŒå°±æ˜¯I/Oå¤šè·¯å¤ç”¨ã€‚åªæœ‰å•ä¸ªçº¿ç¨‹(ä¸€ä¸ªå¿«é€’å‘˜)ï¼Œé€šè¿‡è·Ÿè¸ªæ¯ä¸ªI/Oæµçš„çŠ¶æ€(æ¯ä¸ªå¿«é€’çš„é€è¾¾åœ°ç‚¹)ï¼Œæ¥ç®¡ç†å¤šä¸ªI/Oæµã€‚

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ã€‚æˆ‘ä»¬çš„redis-clientåœ¨æ“ä½œçš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿå…·æœ‰ä¸åŒäº‹ä»¶ç±»å‹çš„socketã€‚åœ¨æœåŠ¡ç«¯ï¼Œæœ‰ä¸€æ®µI/0å¤šè·¯å¤ç”¨ç¨‹åºï¼Œå°†å…¶ç½®å…¥é˜Ÿåˆ—ä¹‹ä¸­ã€‚ç„¶åï¼Œæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼Œä¾æ¬¡å»é˜Ÿåˆ—ä¸­å–ï¼Œè½¬å‘åˆ°ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ä¸­ã€‚

##### 2.4 äº‹ä»¶æœºåˆ¶

rediså¹¶æ²¡æœ‰é‡‡ç”¨libeventåº“ä½œä¸ºäº‹ä»¶æœºåˆ¶çš„åº•å±‚å®ç°ï¼Œè€Œæ˜¯è‡ªå·±å¯¹ioå¤šè·¯å¤ç”¨è¿›è¡Œäº†å°è£…ï¼Œå³å¯ä»¥é‡‡ç”¨selectã€epollã€evportã€kqueueä½œä¸ºåº•å±‚çš„å®ç°ã€‚rediså®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡æ—¶ï¼Œredisæä¾›äº†å‘½ä»¤äº‹ä»¶(ä¹Ÿå°±æ˜¯æ–‡ä»¶äº‹ä»¶)ã€‚å¦å¤–redisè¿˜æä¾›äº†å®šæ—¶äº‹ä»¶ï¼Œç”¨äºå¯¹ç³»ç»Ÿå®æ—¶æ€§è¦æ±‚è¿›è¡Œå¤„ç†ï¼Œä»¥åŠå¤„ç†ç”¨æˆ·çš„ä¸šåŠ¡éœ€æ±‚ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghhgzbuayqj30pz0t0wfq.jpg)

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghhh1q2ou4j30zk09mwf3.jpg)

1. é¦–å…ˆ redis æœåŠ¡å™¨è¿è¡Œï¼Œç›‘å¬å¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶å¤„äºç›‘å¬çš„çŠ¶æ€ä¸‹ï¼Œæ­¤æ—¶**è¿æ¥åº”ç­”å¤„ç†å™¨**å·¥ä½œï¼Œ
2. å®¢æˆ·ç«¯ä¸ redis æœåŠ¡å™¨å‘èµ·å»ºç«‹è¿æ¥ï¼Œç›‘å¬å¥—æ¥å­—äº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼Œå½“ IO å¤šè·¯å¤ç”¨ç¨‹åºç›‘å¬åˆ°å…¶å‡†å¤‡å°±ç»ªåï¼Œå°†è¯¥äº‹ä»¶å‹å…¥é˜Ÿåˆ—ä¸­ï¼Œç”±æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨è·å–é˜Ÿåˆ—ä¸­çš„äº‹ä»¶äº¤äº**è¿æ¥åº”ç­”å¤„ç†å™¨**å·¥ä½œå¤„ç†ï¼Œåº”ç­”å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æˆåŠŸï¼ŒåŒæ—¶å°†å®¢æˆ·ç«¯ socket çš„ AE_READABLE äº‹ä»¶å‹å…¥é˜Ÿåˆ—ç”±æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨è·å–é˜Ÿåˆ—ä¸­çš„äº‹ä»¶äº¤**å‘½ä»¤è¯·æ±‚å¤„ç†å™¨å…³è”**
3. å®¢æˆ·ç«¯å‘é€ set key value è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ socket çš„ AE_READABLE äº‹ä»¶ï¼Œå½“ IO å¤šè·¯å¤ç”¨ç¨‹åºç›‘å¬åˆ°å…¶å‡†å¤‡å°±ç»ªåï¼Œå°†è¯¥äº‹ä»¶å‹å…¥é˜Ÿåˆ—ä¸­ï¼Œç”±æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨è·å–é˜Ÿåˆ—ä¸­çš„äº‹ä»¶äº¤äº**å‘½ä»¤è¯·æ±‚å¤„ç†å™¨å…³è”**å¤„ç†
4. **å‘½ä»¤è¯·æ±‚å¤„ç†å™¨å…³è”**å¤„ç†å®Œæˆåï¼Œéœ€è¦å“åº”å®¢æˆ·ç«¯æ“ä½œå®Œæˆï¼Œæ­¤æ—¶å°†äº§ç”Ÿ socket çš„ AE_WRITEABLE äº‹ä»¶å‹å…¥é˜Ÿåˆ—ï¼Œç”±æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨è·å–é˜Ÿåˆ—ä¸­çš„äº‹ä»¶äº¤äº**å‘½ä»¤æ¢å¤å¤„ç†å™¨**å¤„ç†ï¼Œè¿”å›æ“ä½œç»“æœï¼Œå®Œæˆåå°†è§£é™¤ AE_WRITEABLE äº‹ä»¶ä¸**å‘½ä»¤æ¢å¤å¤„ç†å™¨**çš„å…³è”

##### 2.5 reactoræ¨¡å¼

å¤§ä½“ä¸Šå¯ä»¥è¯´ Redis çš„å·¥ä½œæ¨¡å¼æ˜¯ï¼Œreactor æ¨¡å¼é…åˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨ä¸€ä¸ª serverAccept çº¿ç¨‹æ¥å¤„ç†å»ºç«‹è¯·æ±‚çš„é“¾æ¥ï¼Œå¹¶ä¸”é€šè¿‡ IO å¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œè®©å†…æ ¸æ¥ç›‘å¬è¿™äº› socketï¼Œä¸€æ—¦æŸäº› socket çš„è¯»å†™äº‹ä»¶å‡†å¤‡å°±ç»ªåå°±å¯¹åº”çš„äº‹ä»¶å‹å…¥é˜Ÿåˆ—ä¸­ï¼Œç„¶å worker å·¥ä½œï¼Œç”±æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä»ä¸­è·å–äº‹ä»¶äº¤äºå¯¹åº”çš„å¤„ç†å™¨å»æ‰§è¡Œï¼Œå½“æŸä¸ªäº‹ä»¶æ‰§è¡Œå®Œæˆåæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨æ‰ä¼šä»é˜Ÿåˆ—ä¸­è·å–ä¸‹ä¸€ä¸ªäº‹ä»¶è¿›è¡Œå¤„ç†

> å¯ä»¥ç±»æ¯”åœ¨ netty ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè®¾ç½® bossGroup å’Œ workerGroup é»˜è®¤æƒ…å†µä¸‹ bossGroup ä¸º 1ï¼ŒworkerGroup = 2 * cpu æ•°é‡ï¼Œè¿™æ ·å¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ¥å¤„ç†è¯»å†™å°±ç»ªçš„äº‹ä»¶ï¼Œä½†æ˜¯å…¶ä¸­ä¸èƒ½æœ‰æ¯”è¾ƒè€—æ—¶çš„æ“ä½œå¦‚æœæœ‰çš„è¯éœ€è¦å°†å…¶æ”¾å…¥çº¿ç¨‹æ± ä¸­ï¼Œä¸ç„¶ä¼šé™ä½å…¶ååé‡ã€‚åœ¨ redis ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åšè¿™äºŒè€…çš„å€¼éƒ½æ˜¯ 1

https://juejin.im/post/6844903954917097486

https://blog.csdn.net/javaer_lee/article/details/87444386

https://draveness.me/redis-io-multiplexing/

https://juejin.im/post/6844904082176475144

https://blog.csdn.net/u014590757/article/details/79860766

https://juejin.im/post/6844903909073354766

https://zhuanlan.zhihu.com/p/76794272

https://blog.csdn.net/ApeLife/article/details/50926497

